<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>矿机冷却系统监控平台 - 实时数据</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        :root {
            --primary-color: #1890ff;
            --success-color: #52c41a;
            --warning-color: #faad14;
            --error-color: #f5222d;
            --gray-1: #ffffff;
            --gray-2: #f0f0f0;
            --shadow-card: 0 4px 12px rgba(0, 0, 0, 0.08);
            --border-radius-base: 8px;
            --space-md: 16px;
            --space-lg: 24px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft YaHei', sans-serif; background-color: var(--gray-2); min-height: 100vh; }
        .container { max-width: 1920px; margin: 0 auto; padding: var(--space-md); }
        
        .navbar {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--gray-1); padding: var(--space-md) var(--space-lg);
            border-radius: var(--border-radius-base); box-shadow: var(--shadow-card); margin-bottom: var(--space-lg);
        }
        .logo { display: flex; align-items: center; gap: 12px; font-size: 20px; font-weight: bold; }
        .logo-icon { width: 40px; height: 40px; background: linear-gradient(135deg, var(--primary-color), #52c41a); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; }
        .navbar-info { display: flex; align-items: center; gap: 20px; }
        .status-badge { padding: 4px 12px; border-radius: 12px; font-size: 12px; }
        .status-ok { background: #e6f7e6; color: var(--success-color); }
        .status-error { background: #fff1f0; color: var(--error-color); }
        .refresh-btn { padding: 8px 16px; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer; }
        .refresh-btn:hover { background: #40a9ff; }
        
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: var(--space-md); margin-bottom: var(--space-lg); }
        .kpi-card { background: var(--gray-1); padding: var(--space-lg); border-radius: var(--border-radius-base); box-shadow: var(--shadow-card); }
        .kpi-title { font-size: 14px; color: #666; margin-bottom: 8px; }
        .kpi-value { font-size: 32px; font-weight: bold; color: var(--primary-color); }
        .kpi-unit { font-size: 14px; margin-left: 4px; }
        .kpi-trend { font-size: 12px; margin-top: 8px; }
        .trend-up { color: var(--success-color); }
        .trend-down { color: var(--error-color); }
        
        .chart-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: var(--space-md); margin-bottom: var(--space-lg); }
        .chart-card { background: var(--gray-1); padding: var(--space-lg); border-radius: var(--border-radius-base); box-shadow: var(--shadow-card); }
        .chart-title { font-size: 16px; font-weight: bold; margin-bottom: 16px; }
        .chart-container { height: 300px; }
        
        .sites-section { background: var(--gray-1); padding: var(--space-lg); border-radius: var(--border-radius-base); box-shadow: var(--shadow-card); }
        .section-title { font-size: 16px; font-weight: bold; margin-bottom: 16px; }
        .sites-table { width: 100%; border-collapse: collapse; }
        .sites-table th, .sites-table td { padding: 12px; text-align: left; border-bottom: 1px solid #e8e8e8; }
        .sites-table th { background: #fafafa; font-weight: 600; }
        .site-status { display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; border-radius: 4px; font-size: 12px; }
        .site-online { background: #e6f7e6; color: var(--success-color); }
        .site-offline { background: #fff1f0; color: var(--error-color); }
        
        .loading { text-align: center; padding: 40px; color: #999; }
        .error-msg { background: #fff1f0; border: 1px solid #ffa4a4; color: var(--error-color); padding: 12px; border-radius: 4px; margin: 16px 0; }
        
        @media (max-width: 768px) {
            .chart-grid { grid-template-columns: 1fr; }
            .kpi-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 顶部导航栏 -->
        <div class="navbar">
            <div class="logo">
                <div class="logo-icon"><i class="fas fa-server"></i></div>
                <span>AntBox 矿机冷却监控系统</span>
            </div>
            <div class="navbar-info">
                <span id="api-status" class="status-badge status-ok"><i class="fas fa-check-circle"></i> API 正常</span>
                <span id="current-time"></span>
                <button class="refresh-btn" onclick="loadAllData()"><i class="fas fa-sync-alt"></i> 刷新</button>
            </div>
        </div>

        <!-- KPI 卡片 -->
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-title"><i class="fas fa-building"></i> 总站点数</div>
                <div class="kpi-value" id="total-sites">--<span class="kpi-unit">个</span></div>
                <div class="kpi-trend" id="online-rate">在线率：--</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-title"><i class="fas fa-plug"></i> 在线站点</div>
                <div class="kpi-value" id="online-sites">--<span class="kpi-unit">个</span></div>
                <div class="kpi-trend" id="offline-sites">离线：--</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-title"><i class="fas fa-bolt"></i> 总功耗</div>
                <div class="kpi-value" id="total-power">--<span class="kpi-unit">MW</span></div>
                <div class="kpi-trend">昨日：--</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-title"><i class="fas fa-tachometer-alt"></i> 总算力</div>
                <div class="kpi-value" id="total-hashrate">--<span class="kpi-unit">PH/s</span></div>
                <div class="kpi-trend">昨日：--</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-title"><i class="fas fa-thermometer-half"></i> 平均温度</div>
                <div class="kpi-value" id="avg-temp">--<span class="kpi-unit">°C</span></div>
                <div class="kpi-trend">昨日：--</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-title"><i class="fas fa-exclamation-triangle"></i> 活动告警</div>
                <div class="kpi-value" id="active-alerts">--<span class="kpi-unit">个</span></div>
                <div class="kpi-trend" style="color: var(--error-color)">需关注</div>
            </div>
        </div>

        <!-- 图表区域 -->
        <div class="chart-grid">
            <div class="chart-card">
                <div class="chart-title"><i class="fas fa-chart-line"></i> 总功耗趋势 (24 小时)</div>
                <div class="chart-container" id="power-chart"></div>
            </div>
            <div class="chart-card">
                <div class="chart-title"><i class="fas fa-microchip"></i> 总算力趋势 (24 小时)</div>
                <div class="chart-container" id="hashrate-chart"></div>
            </div>
            <div class="chart-card">
                <div class="chart-title"><i class="fas fa-thermometer-three-quarters"></i> 平均温度趋势 (24 小时)</div>
                <div class="chart-container" id="temp-chart"></div>
            </div>
            <div class="chart-card">
                <div class="chart-title"><i class="fas fa-signal"></i> 在线站点趋势 (24 小时)</div>
                <div class="chart-container" id="online-chart"></div>
            </div>
        </div>

        <!-- 站点列表 -->
        <div class="sites-section">
            <div class="section-title"><i class="fas fa-list"></i> 站点列表</div>
            <div id="sites-loading" class="loading">正在加载站点数据...</div>
            <div id="sites-error" class="error-msg" style="display:none"></div>
            <table class="sites-table" id="sites-table" style="display:none">
                <thead>
                    <tr>
                        <th>站点 ID</th>
                        <th>IP 地址</th>
                        <th>位置</th>
                        <th>状态</th>
                        <th>供液温度</th>
                        <th>回液温度</th>
                        <th>功耗</th>
                        <th>算力</th>
                        <th>最后更新</th>
                    </tr>
                </thead>
                <tbody id="sites-tbody"></tbody>
            </table>
        </div>
    </div>

    <script>
        // API 配置 - 使用相对路径，通过同一服务器访问
        // API 路由：/api/health, /api/dashboard/overview, /api/sites, /api/trend/{metric}
        const API_BASE = '/api';
        
        // 更新时间
        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = 
                now.toLocaleString('zh-CN', { hour12: false });
        }
        setInterval(updateTime, 1000);
        updateTime();

        // API 请求封装
        async function apiRequest(endpoint) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error(`API 请求失败 ${endpoint}:`, error);
                throw error;
            }
        }

        // 加载总览数据
        async function loadOverview() {
            try {
                const data = await apiRequest('/dashboard/overview');
                
                document.getElementById('total-sites').innerHTML = `${data.total_sites || 0}<span class="kpi-unit">个</span>`;
                document.getElementById('online-sites').innerHTML = `${data.online_sites || 0}<span class="kpi-unit">个</span>`;
                document.getElementById('offline-sites').textContent = `离线：${data.offline_sites || 0}`;
                
                const onlineRate = data.total_sites > 0 ? ((data.online_sites / data.total_sites) * 100).toFixed(1) : 0;
                document.getElementById('online-rate').textContent = `在线率：${onlineRate}%`;
                
                document.getElementById('total-power').innerHTML = `${(data.total_power || 0).toFixed(2)}<span class="kpi-unit">MW</span>`;
                document.getElementById('total-hashrate').innerHTML = `${(data.total_hashrate || 0).toFixed(2)}<span class="kpi-unit">PH/s</span>`;
                document.getElementById('avg-temp').innerHTML = `${(data.avg_supply_temp || 0).toFixed(1)}<span class="kpi-unit">°C</span>`;
                document.getElementById('active-alerts').innerHTML = `${data.active_alerts || 0}<span class="kpi-unit">个</span>`;
                
                updateApiStatus(true);
            } catch (error) {
                updateApiStatus(false);
                console.error('加载总览数据失败:', error);
            }
        }

        // 更新 API 状态
        function updateApiStatus(online) {
            const badge = document.getElementById('api-status');
            if (online) {
                badge.className = 'status-badge status-ok';
                badge.innerHTML = '<i class="fas fa-check-circle"></i> API 正常';
            } else {
                badge.className = 'status-badge status-error';
                badge.innerHTML = '<i class="fas fa-times-circle"></i> API 离线';
            }
        }

        // 加载站点列表
        async function loadSites() {
            const tbody = document.getElementById('sites-tbody');
            const loading = document.getElementById('sites-loading');
            const errorDiv = document.getElementById('sites-error');
            const table = document.getElementById('sites-table');
            
            try {
                const sites = await apiRequest('/sites?limit=100');
                loading.style.display = 'none';
                table.style.display = 'table';
                
                tbody.innerHTML = sites.map(site => `
                    <tr>
                        <td>${site.site_id}</td>
                        <td>${site.ip_address || '-'}</td>
                        <td>${site.location || '-'}</td>
                        <td><span class="site-status ${site.is_online ? 'site-online' : 'site-offline'}">
                            <i class="fas fa-circle" style="font-size:8px"></i>
                            ${site.is_online ? '在线' : '离线'}
                        </span></td>
                        <td>${site.supply_temp ? site.supply_temp.toFixed(1) + '°C' : '-'}</td>
                        <td>${site.return_temp ? site.return_temp.toFixed(1) + '°C' : '-'}</td>
                        <td>${site.total_power ? site.total_power.toFixed(2) + ' KW' : '-'}</td>
                        <td>${site.total_hashrate ? site.total_hashrate.toFixed(2) + ' PH/s' : '-'}</td>
                        <td>${site.last_update ? new Date(site.last_update).toLocaleString('zh-CN') : '-'}</td>
                    </tr>
                `).join('');
            } catch (error) {
                loading.style.display = 'none';
                errorDiv.style.display = 'block';
                errorDiv.textContent = '加载站点数据失败：' + error.message;
            }
        }

        // 初始化图表
        let charts = {};
        
        function initCharts() {
            charts.power = echarts.init(document.getElementById('power-chart'));
            charts.hashrate = echarts.init(document.getElementById('hashrate-chart'));
            charts.temp = echarts.init(document.getElementById('temp-chart'));
            charts.online = echarts.init(document.getElementById('online-chart'));
            
            // 窗口大小变化时重绘图表
            window.addEventListener('resize', () => {
                Object.values(charts).forEach(chart => chart.resize());
            });
        }

        // 加载趋势数据
        async function loadTrends() {
            try {
                const [power, hashrate, temp] = await Promise.all([
                    apiRequest('/trend/total_power?hours=24'),
                    apiRequest('/trend/total_hashrate?hours=24'),
                    apiRequest('/trend/supply_temp?hours=24')
                ]);
                
                updateChart(charts.power, power.data || [], '功耗', 'MW', '#f5222d');
                updateChart(charts.hashrate, hashrate.data || [], '算力', 'PH/s', '#52c41a');
                updateChart(charts.temp, temp.data || [], '温度', '°C', '#faad14');
            } catch (error) {
                console.error('加载趋势数据失败:', error);
            }
        }

        // 更新单个图表
        function updateChart(chart, data, name, unit, color) {
            if (!data.length) {
                chart.setOption({
                    xAxis: { data: [] },
                    series: [{ data: [], name }]
                });
                return;
            }
            
            const times = data.map(d => new Date(d.timestamp).toLocaleTimeString('zh-CN', {hour: '2-digit', minute:'2-digit'}));
            const values = data.map(d => d.value !== null ? d.value : 0);
            
            chart.setOption({
                tooltip: { trigger: 'axis', formatter: `{b}<br/>{a}: {c} ${unit}` },
                xAxis: { type: 'category', data: times, axisLabel: { rotate: 45 } },
                yAxis: { type: 'value', name: `${name} (${unit})` },
                series: [{
                    name, type: 'line', data: values, smooth: true,
                    itemStyle: { color },
                    areaStyle: {
                        color: { type: 'linear', x: 0, y: 0, x2: 0, y2: 1,
                            colorStops: [{offset: 0, color: hexToRgba(color, 0.3)}, {offset: 1, color: hexToRgba(color, 0.05)}]
                        }
                    }
                }]
            });
        }

        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        // 加载所有数据
        async function loadAllData() {
            console.log('开始加载数据...');
            await Promise.all([
                loadOverview(),
                loadSites(),
                loadTrends()
            ]);
            console.log('数据加载完成');
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            loadAllData();
            
            // 每 60 秒自动刷新
            setInterval(loadAllData, 60000);
        });
    </script>
</body>
</html>
