## ğŸ“Š AntBox çŸ¿æœºå†·å´ç›‘æ§é¡¹ç›® - 2026-02-23 ä¿®å¤è®°å½•

### ç´§æ€¥é—®é¢˜ä¿®å¤ (2026-02-23 20:19-20:32)

#### é—®é¢˜ 1: ä¸»é¡µæ•°æ®æ˜¾ç¤ºé”™è¯¯ âœ… å·²ä¿®å¤
**ç°è±¡**: æ€»åŠŸè€—æ˜¾ç¤º 0.14 MWï¼ˆåº”ä¸º 138 MWï¼‰ï¼Œæ€»ç®—åŠ›æ˜¾ç¤º 0.007 PH/sï¼ˆåº”ä¸º 7.129 EH/sï¼‰

**åŸå› **: API å·²è¿”å› MW å’Œ EH/s å•ä½ï¼Œå‰ç«¯åˆé™¤ä»¥ 1000 å¯¼è‡´åŒé‡è½¬æ¢

**ä¿®å¤æ–‡ä»¶**: `/home/caihong/antmonitor/index.html`
```javascript
// ä¿®å¤å‰ï¼ˆé”™è¯¯ï¼‰
const powerMW = (data.total_power / 1000).toFixed(2);
const hashratePH = (data.total_hashrate / 1000).toFixed(3);

// ä¿®å¤åï¼ˆæ­£ç¡®ï¼‰
document.getElementById('total-power').innerHTML = data.total_power.toFixed(2) + '<span class="kpi-unit">MW</span>';
document.getElementById('total-hashrate').innerHTML = data.total_hashrate.toFixed(3) + '<span class="kpi-unit">EH/s</span>';
```

---

#### é—®é¢˜ 2: æ‰‹åŠ¨æ·»åŠ è®¾å¤‡ä¸æ˜¾ç¤º âœ… å·²ä¿®å¤
**ç°è±¡**: æ‰«æé¡µé¢æ‰‹åŠ¨æ·»åŠ  IPï¼ˆå¦‚ 10.1.101.1ï¼‰åï¼Œå…¨ç«™æ•°æ®é¡µé¢ä¸æ˜¾ç¤º

**åŸå› **: å‰ç«¯åªæ·»åŠ  DOM å…ƒç´ ï¼Œæœªä¿å­˜åˆ°æ•°æ®åº“

**ä¿®å¤æ–¹æ¡ˆ**:
1. **æ·»åŠ  POST API ç«¯ç‚¹** (`api_server.py`):
```python
class SiteCreate(BaseModel):
    ip_address: str
    location: Optional[str] = None

@app.post("/api/sites", status_code=201)
async def add_site(site: SiteCreate):
    """æ·»åŠ æ–°ç«™ç‚¹"""
    async with db_pool.acquire() as conn:
        exists = await conn.fetchval("SELECT 1 FROM sites WHERE ip_address = $1", site.ip_address)
        if exists:
            raise HTTPException(status_code=400, detail="è¯¥ IP å·²å­˜åœ¨")
        
        await conn.execute("""
            INSERT INTO sites (ip_address, location, is_online)
            VALUES ($1, $2, true)
        """, site.ip_address, site.location or 'æ‰‹åŠ¨æ·»åŠ ')
        
        return {"message": "ç«™ç‚¹æ·»åŠ æˆåŠŸ", "ip_address": site.ip_address}
```

2. **å‰ç«¯è°ƒç”¨ API** (`pages/saomiao.html`):
```javascript
btnManualAdd.addEventListener('click', async () => {
    try {
        const response = await fetch('/api/sites', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ip_address: ip, location: 'æ‰‹åŠ¨æ·»åŠ ' })
        });
        
        if (response.ok) {
            addLog(`æ‰‹åŠ¨æ·»åŠ  IP æˆåŠŸï¼š${ip}ï¼Œå·²ä¿å­˜åˆ°æ•°æ®åº“`, 'success');
            setTimeout(() => location.reload(), 1500);
        }
    } catch (error) {
        addLog(`æ·»åŠ å¤±è´¥ï¼š${error.message}`, 'error');
    }
});
```

**æµ‹è¯•éªŒè¯**:
```bash
curl -X POST https://192.168.0.57:8443/api/sites \
  -H "Content-Type: application/json" \
  -d '{"ip_address":"10.1.99.1","location":"æµ‹è¯•"}'
# å“åº”ï¼š{"message":"ç«™ç‚¹æ·»åŠ æˆåŠŸ","ip_address":"10.1.99.1"}
```

---

#### é—®é¢˜ 3: å¹³å‡æ¸©åº¦æ— æ•°æ® â³ éƒ¨åˆ†ä¿®å¤
**æ–¹æ¡ˆ**: æ·»åŠ æ•°æ®æŒä¹…åŒ–é€»è¾‘ï¼Œå½“é‡‡é›†å¤±è´¥æ—¶ä½¿ç”¨ä¸Šä¸€æ¬¡æ•°æ®

**ä¿®å¤æ–‡ä»¶**: `/home/caihong/antmonitor/api_server.py`
```python
# å¦‚æœå½“å‰æ— æ•°æ®ï¼Œä½¿ç”¨ä¸Šä¸€æ¬¡é‡‡é›†çš„æ•°æ®
if total_power is None:
    last_data = await conn.fetchrow(
        "SELECT total_power, total_hashrate, miner_count, avg_miner_temp FROM site_status_history WHERE ip = $1 ORDER BY timestamp DESC LIMIT 1",
        ip
    )
    if last_data:
        total_power = last_data["total_power"]
        total_hashrate = last_data["total_hashrate"]
        miner_count = last_data["miner_count"]
        avg_miner_temp = last_data["avg_miner_temp"]
```

---

#### é—®é¢˜ 4: 24 å°æ—¶è¶‹åŠ¿æ•°æ®ç¼ºå¤± â³ å·²æ·»åŠ  API
**æ–°å¢ API**: `/api/trends/24h`

```python
@app.get("/api/trends/24h")
async def get_24h_trends():
    """è·å– 24 å°æ—¶è¶‹åŠ¿æ•°æ®"""
    async with db_pool.acquire() as conn:
        rows = await conn.fetch("""
            SELECT 
                date_trunc('hour', timestamp) as hour,
                AVG(total_power) as avg_power,
                AVG(total_hashrate) as avg_hashrate,
                AVG(supply_temp) as avg_temp,
                COUNT(*) FILTER (WHERE is_online) as online_count
            FROM site_status_history
            WHERE timestamp >= NOW() - INTERVAL '24 hours'
            GROUP BY date_trunc('hour', timestamp)
            ORDER BY hour
        """)
        
        return {
            "power": [{"time": str(r["hour"]), "value": round(float(r["avg_power"]) / 1000, 2)} for r in rows],
            "hashrate": [{"time": str(r["hour"]), "value": round(float(r["avg_hashrate"]) / 1000000, 3)} for r in rows],
            "temp": [{"time": str(r["hour"]), "value": round(float(r["avg_temp"]), 1)} for r in rows],
            "online": [{"time": str(r["hour"]), "value": r["online_count"]} for r in rows]
        }
```

---

#### é—®é¢˜ 5: é‡å¤å’Œé AntBox è®¾å¤‡æ¸…ç† âœ… å·²å®Œæˆ
**æ¸…ç†è„šæœ¬**:
```python
# åˆ é™¤æµ‹è¯•è®¾å¤‡ (10.1.99.x)
await conn.execute("DELETE FROM sites WHERE ip_address::text LIKE '10.1.99%'")

# åˆ é™¤é 10.x ç½‘æ®µ
await conn.execute("DELETE FROM sites WHERE ip_address::text NOT LIKE '10.%'")

# åˆ é™¤é‡å¤ IP
await conn.execute("""
    DELETE FROM sites a USING sites b
    WHERE a.ip_address = b.ip_address AND a.site_id < b.site_id
""")
```

**ç»“æœ**: 157 â†’ 156 ä¸ªç«™ç‚¹

---

### ğŸ“‹ ä¿®æ”¹æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | çŠ¶æ€ |
|------|---------|------|
| `/home/caihong/antmonitor/index.html` | å•ä½è½¬æ¢ä¿®å¤ | âœ… |
| `/home/caihong/antmonitor/pages/quanzhan.html` | å•ä½è½¬æ¢ä¿®å¤ | âœ… |
| `/home/caihong/antmonitor/pages/saomiao.html` | POST API è°ƒç”¨ + é¡µé¢åˆ·æ–° | âœ… |
| `/home/caihong/antmonitor/api_server.py` | POST /api/sites + SiteCreate æ¨¡å‹ + æ•°æ®æŒä¹…åŒ– + 24h è¶‹åŠ¿ API | âœ… |

---

### ğŸ¯ å½“å‰ç³»ç»ŸçŠ¶æ€ (2026-02-23 20:30)

```json
{
    "total_sites": 156,
    "online_sites": 149,
    "offline_sites": 7,
    "total_power": 137.89,
    "total_hashrate": 7.129,
    "avg_supply_temp": 34.4,
    "active_alerts": 0
}
```

**é¡µé¢çŠ¶æ€**:
- ä¸»é¡µï¼š200 âœ…
- å…¨ç«™æ•°æ®ï¼š200 âœ…
- ç«™ç‚¹æ‰«æï¼š200 âœ…

---

### ğŸ“¡ Telegram é€šçŸ¥
- **å‘é€æ—¶é—´**: 2026-02-23 20:30
- **æ¶ˆæ¯ ID**: 144
- **å†…å®¹**: ç³»ç»ŸçŠ¶æ€æŠ¥å‘Š + ä¿®å¤æ¸…å•

---

### âš ï¸ å¾…éªŒè¯é¡¹ç›®
1. ç«™ç‚¹å®æ—¶æ•°æ®å¡ç‰‡å®é™…æ¸²æŸ“ï¼ˆAPI æ­£å¸¸ï¼Œéœ€æµè§ˆå™¨æ£€æŸ¥ï¼‰
2. 24 å°æ—¶è¶‹åŠ¿ API å‰ç«¯é›†æˆ
3. æ‰‹åŠ¨æ·»åŠ è®¾å¤‡å®Œæ•´æµç¨‹æµ‹è¯•

---

*è®°å½•æ—¶é—´ï¼š2026-02-23 20:32 (Asia/Muscat)*
